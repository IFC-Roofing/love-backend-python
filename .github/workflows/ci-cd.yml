name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Compile check
        run: python -m compileall .

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: build
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit info
        id: commit-info
        run: |
          COMMIT_HASH=$(echo "${{ github.sha }}" | cut -c1-7)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" | sed 's/"/\\"/g')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT

      - name: Notify Slack on Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data @- $SLACK_WEBHOOK_URL <<EOF
          {
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "✅ *Love Server* build and checks succeeded"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "*${{ steps.commit-info.outputs.hash }}* ${{ steps.commit-info.outputs.message }} — ${{ steps.commit-info.outputs.author }}"
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "View Build" },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "View Commit" },
                    "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
                  }
                ]
              }
            ]
          }
          EOF
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_LOGS_URL }}
